From 8a7a0a8e2161b81d22233ccf8af4ca5763f1535c Mon Sep 17 00:00:00 2001
From: Samuel Holland <samuel@sholland.org>
Date: Thu, 18 Oct 2018 00:02:39 +0200
Subject: [PATCH 01/11] Require static native libraries when linking static
 executables

---
 src/librustc_codegen_llvm/back/link.rs | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/librustc_codegen_llvm/back/link.rs b/src/librustc_codegen_llvm/back/link.rs
index 845a66c6e..1b3185c02 100644
--- a/src/librustc_codegen_llvm/back/link.rs
+++ b/src/librustc_codegen_llvm/back/link.rs
@@ -1597,6 +1597,14 @@ fn add_upstream_native_libraries(cmd: &mut dyn Linker,
             }
             match lib.kind {
                 NativeLibraryKind::NativeUnknown => cmd.link_dylib(&name.as_str()),
+                NativeLibraryKind::NativeUnknown => {
+                    // When creating executables, match library linkage to that of the executable.
+                    if crate_type == config::CrateTypeExecutable && sess.crt_static() {
+                        cmd.link_staticlib(&lib.name.as_str())
+                    } else {
+                        cmd.link_dylib(&lib.name.as_str())
+                    }
+                },
                 NativeLibraryKind::NativeFramework => cmd.link_framework(&name.as_str()),
                 NativeLibraryKind::NativeStaticNobundle => {
                     // Link "static-nobundle" native libs only if the crate they originate from
-- 
2.19.1

